version: '3.8'

services:
  # ======================================================================
  # SERVICIOS DE KAFKA
  # ======================================================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.4.0
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - kafka-network

  kafka:
    image: confluentinc/cp-kafka:7.4.0
    depends_on:
      - zookeeper
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092,EXTERNAL://172.20.10.12:29092
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT,EXTERNAL:PLAINTEXT
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
    ports:
      - "9092:9092"
      - "29092:29092"
    networks:
      - kafka-network
    healthcheck:
      test: ["CMD", "kafka-topics", "--list", "--bootstrap-server", "localhost:9092"]
      interval: 10s
      timeout: 10s
      retries: 10
      start_period: 40s

  kafka-init:
    image: confluentinc/cp-kafka:7.4.0
    depends_on:
      - kafka
    command: > 
      sh -c "
        sleep 5 &&
        echo 'Creando tópicos...' &&
        kafka-topics --create --topic supply_flow --partitions 3 --replication-factor 1 --bootstrap-server kafka:9092 || true &&
        kafka-topics --create --topic supply_response --partitions 3 --replication-factor 1 --bootstrap-server kafka:9092 || true &&
        kafka-topics --create --topic driver_responses --partitions 3 --replication-factor 1 --bootstrap-server kafka:9092 || true &&
        kafka-topics --create --topic driver_requests --partitions 3 --replication-factor 1 --bootstrap-server kafka:9092 || true &&
        kafka-topics --create --topic control_commands --partitions 3 --replication-factor 1 --bootstrap-server kafka:9092 || true &&
        kafka-topics --create --topic engine_tickets --partitions 3 --replication-factor 1 --bootstrap-server kafka:9092 || true &&
        kafka-topics --create --topic driver_tickets --partitions 3 --replication-factor 1 --bootstrap-server kafka:9092 || true &&
        echo 'Tópicos creados:' &&
        kafka-topics --list --bootstrap-server kafka:9092
      "
    profiles:
      - init
    networks:
      - kafka-network

  # ======================================================================
  # 3. SERVIDOR POSTGRESQL (Base de Datos Distribuida) - AÑADIDO
  # ======================================================================
  postgres:
    image: postgres:15-alpine
    container_name: ev_charging-postgres
    environment:
      POSTGRES_DB: ev_db
      POSTGRES_USER: user
      POSTGRES_PASSWORD: password
    ports:
      - "5432:5432"
    volumes:
      # Bind Mount: Usa la carpeta local './db' para persistencia
      - ./db:/var/lib/postgresql/data 
    networks:
      - kafka-network # <--- ¡CRÍTICO para la comunicación!
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user"]
      interval: 5s
      timeout: 5s
      retries: 5
      start_period: 10s

  # ======================================================================
  # 4. SERVICIO DE REGISTRY (Cliente SQL)
  # ======================================================================
  registry:
    build: ./registry
    ports:
      - "8081:8080"
    environment:
      - DB_HOST=postgres       
      - DB_NAME=ev_db
      - DB_USER=user
      - DB_PASSWORD=password
    depends_on:
      postgres:
        condition: service_healthy
    networks:
      - kafka-network
    command: ["tail", "-f", "/dev/null"]

  # ======================================================================
  # 5. RESTO DE SERVICIOS
  # ======================================================================
  cp_engine:
    build: ./cp_engine
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - kafka-network
    ports:
      - "6000-6009:6000"
    environment: 
      - LANG=C.UTF-8
      - LC_ALL=C.UTF-8
    volumes:
      - ./engine_status:/app/estado_engine
    command: ["tail", "-f", "/dev/null"]

  cp_monitor:
    build: ./cp_monitor
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - kafka-network
    environment:
      - LANG=C.UTF-8
      - LC_ALL=C.UTF-8
      - REGISTRY_URL=https://registry:8080 
    command: ["tail", "-f", "/dev/null"]

  driver:
    build: ./driver
    depends_on:
      kafka:
        condition: service_healthy
    networks:
      - kafka-network
    environment:
      - LANG=C.UTF-8
      - LC_ALL=C.UTF-8
    volumes:
      - ./suministros_driver:/app/suministros_driver
    command: ["tail", "-f", "/dev/null"]

  central:
    build: ./central
    depends_on:
      kafka:
        condition: service_healthy
      postgres:  # <-- AÑADIR DEPENDENCIA DE POSTGRES
        condition: service_healthy
    ports:
      - "5000:5000"
    networks:
      - kafka-network
    volumes:
      - ./central_logs:/app/logs  
      - ./central_backups:/app/backups 
    environment:
      - SOCKET_HOST=0.0.0.0
      - SOCKET_PORT=5000
      # CAMBIAR localhost:9092 por kafka:9092 para conexión dentro de Docker
      - KAFKA_SERVERS=kafka:9092 
      - LOG_DIR=/app/logs
      - LANG=C.UTF-8
      - LC_ALL=C.UTF-8
      - DB_HOST=postgres       
      - DB_NAME=ev_db
      - DB_USER=user
      - DB_PASSWORD=password
    # CAMBIAR PARA EJECUTAR EL SCRIPT AUTOMÁTICAMENTE
    command: ["tail", "-f", "/dev/null"]

# ======================================================================
# REDES Y VOLÚMENES
# ======================================================================
networks:
  kafka-network:
    driver: bridge

volumes:
  # Solo necesitamos un volumen nombrado para Kafka
  kafka_data: 