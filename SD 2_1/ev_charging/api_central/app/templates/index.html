<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EV Charging Command Center</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #f3f4f6; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .navbar { background-color: #111827; }
        .stat-card { background: white; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); padding: 1.5rem; height: 100%; }
        .badge-status { padding: 6px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }
        .status-active { background-color: #d1fae5; color: #065f46; }
        .status-charging { background-color: #dbeafe; color: #1e40af; animation: pulse 2s infinite; }
        .status-error { background-color: #fee2e2; color: #991b1b; }
        .status-offline { background-color: #f3f4f6; color: #374151; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }
    </style>
</head>
<body>

    <nav class="navbar navbar-dark mb-4">
        <div class="container">
            <a class="navbar-brand" href="#"><i class="fa-solid fa-charging-station me-2"></i>EV Network Control</a>
            <div class="text-light">
                <span id="connection-status" class="badge bg-warning text-dark">Conectando...</span>
            </div>
        </div>
    </nav>

    <div class="container">
        <div class="row g-4 mb-4">
            <div class="col-md-3">
                <div class="stat-card border-start border-4 border-primary">
                    <div class="text-muted small text-uppercase fw-bold">Total CPs</div>
                    <h2 class="mt-2 mb-0" id="total-cps">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card border-start border-4 border-success">
                    <div class="text-muted small text-uppercase fw-bold">Activos/Cargando</div>
                    <h2 class="mt-2 mb-0" id="active-cps">0</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card border-start border-4 border-info">
                    <div class="text-muted small text-uppercase fw-bold">Energía Total</div>
                    <h2 class="mt-2 mb-0" id="total-energy">0 kWh</h2>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stat-card border-start border-4 border-warning">
                    <div class="text-muted small text-uppercase fw-bold">Ingresos</div>
                    <h2 class="mt-2 mb-0" id="total-revenue">0 €</h2>
                </div>
            </div>
        </div>

        <div class="card shadow-sm border-0">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold text-secondary"><i class="fa-solid fa-list me-2"></i>Estado de Charging Points</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">ID / Ubicación</th>
                                <th>Estado</th>
                                <th>Conductor</th>
                                <th>Potencia Actual</th>
                                <th>Sesión Actual</th>
                                <th>Total Energía / €</th>
                                <th>Acciones</th> </tr>
                            </tr>
                        </thead>
                        <tbody id="cp-table-body">
                            <tr><td colspan="6" class="text-center py-4">Esperando datos de API Central...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="card shadow-sm border-0 mt-4">
            <div class="card-header bg-white py-3">
                <h5 class="mb-0 fw-bold text-secondary"><i class="fa-solid fa-users me-2"></i>Base de Datos de Conductores</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4">ID Conductor</th>
                                <th>Estado Actual</th>
                                <th>Fecha Registro</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody id="drivers-table-body">
                            <tr><td colspan="4" class="text-center py-4">Cargando conductores...</td></tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="text-end mt-2 text-muted small">
            Última actualización: <span id="last-update">-</span>
        </div>
    </div>

    <script>
        function setupEventSource() {
            // Conexión SSE al endpoint nuevo de Python
            const source = new EventSource("/api/stream");
            const statusBadge = document.getElementById('connection-status');

            source.onopen = () => {
                statusBadge.className = 'badge bg-success';
                statusBadge.innerText = 'En vivo (PostgreSQL)';
            };

            source.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    renderData(data);
                    if (data.notifications && data.notifications.length > 0) {
                        data.notifications.forEach(notif => {
                            showToast(notif);
                        });
                    }
                    document.getElementById('last-update').innerText = new Date().toLocaleTimeString();
                } catch (e) {
                    console.error("Error parseando:", e);
                }
            };

            source.onerror = () => {
                statusBadge.className = 'badge bg-danger';
                statusBadge.innerText = 'Desconectado';
                source.close();
                // Reintentar en 5s
                setTimeout(setupEventSource, 5000);
            };
        }

        function renderData(data) {
            const cps = data.charging_points || [];
            
            // Contadores
            let activeCount = 0;
            let totalEnergy = 0;
            let totalRevenue = 0;

            const tbody = document.getElementById('cp-table-body');
            tbody.innerHTML = '';

            // Ordenar por ID numéricamente
            cps.sort((a, b) => {
                // Extraer números del ID (ej: CP-1 -> 1)
                const numA = parseInt(a.cp_id.replace(/\D/g, '')) || 0;
                const numB = parseInt(b.cp_id.replace(/\D/g, '')) || 0;
                return numA - numB;
            });

            if (cps.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-muted">No hay CPs registrados en la Base de Datos</td></tr>';
                return;
            }

            cps.forEach(cp => {
                // Métricas Globales
                if (cp.status === 'ACTIVADO' || cp.status === 'SUMINISTRANDO') activeCount++;
                totalEnergy += (cp.total_energy_supplied || 0);
                totalRevenue += (cp.total_revenue || 0);

                // Iconos y colores de estado
                let badgeClass = 'status-offline';
                let icon = '<i class="fa-solid fa-power-off me-1"></i>';

                if (cp.status === 'ACTIVADO') { 
                    badgeClass = 'status-active'; 
                    icon = '<i class="fa-solid fa-check me-1"></i>';
                } else if (cp.status === 'SUMINISTRANDO') { 
                    badgeClass = 'status-charging'; 
                    icon = '<i class="fa-solid fa-bolt me-1"></i>';
                } else if (cp.status === 'AVERIADO' || cp.status === 'FAILED') { 
                    badgeClass = 'status-error'; 
                    icon = '<i class="fa-solid fa-triangle-exclamation me-1"></i>';
                } else if (cp.status === 'PARADO') {
                    badgeClass = 'bg-warning text-dark';
                    icon = '<i class="fa-solid fa-hand me-1"></i>';
                }

                // Potencia Actual
                let powerHtml = '<span class="text-muted">-</span>';
                if (cp.status === 'SUMINISTRANDO' && cp.current_consumption > 0) {
                    powerHtml = `<strong>${(cp.current_consumption || 0).toFixed(2)} kW</strong>`;
                }

                // Sesión Actual
                let sessionHtml = '<span class="text-muted">-</span>';
                if (cp.current_amount > 0) {
                    sessionHtml = `<span class="text-primary fw-bold">€${(cp.current_amount || 0).toFixed(2)}</span>`;
                }

                // --- CORRECCIÓN DE VARIABLES AQUÍ ---
                // Definimos stopDisabled y stopClass (antes tenías btnDisabled/btnClass)
                
                let stopDisabled = (cp.status === 'PARADO' || cp.status === 'AVERIADO' || cp.status === 'DESCONECTADO' || cp.status === 'FAILED') ? 'disabled' : '';
                let stopClass = cp.status === 'SUMINISTRANDO' ? 'btn-danger' : 'btn-outline-danger';

                let resumeDisabled = (cp.status === 'ACTIVADO' || cp.status === 'SUMINISTRANDO' || cp.status === 'DESCONECTADO') ? 'disabled' : '';
                let resumeClass = (cp.status === 'PARADO' || cp.status === 'AVERIADO') ? 'btn-success' : 'btn-outline-success';

                const row = `
                    <tr>
                        <td class="ps-4">
                            <div class="fw-bold text-dark">CP-${cp.cp_id}</div>
                            <div class="small text-muted"><i class="fa-solid fa-location-dot me-1"></i>${cp.location}</div>
                        </td>
                        <td><span class="badge badge-status ${badgeClass}">${icon} ${cp.status}</span></td>
                        <td>${cp.driver_id || '<span class="text-muted">-</span>'}</td>
                        <td>${powerHtml}</td>
                        <td>${sessionHtml}</td>
                        <td>
                            <div>${(cp.total_energy_supplied || 0).toFixed(1)} kWh</div>
                            <div class="small text-muted">€${(cp.total_revenue || 0).toFixed(2)}</div>
                        </td>
                        <td>
                            <div class="btn-group btn-group-sm" role="group">
                                <button class="btn ${stopClass}" onclick="stopCP('${cp.cp_id}')" ${stopDisabled} title="Parar carga">
                                    <i class="fa-solid fa-stop"></i>
                                </button>
                                <button class="btn ${resumeClass}" onclick="resumeCP('${cp.cp_id}')" ${resumeDisabled} title="Reactivar Punto">
                                    <i class="fa-solid fa-play"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
                tbody.innerHTML += row;
            });

            const drivers = data.drivers || [];
            const driversBody = document.getElementById('drivers-table-body');
            driversBody.innerHTML = '';

            if (drivers.length === 0) {
                driversBody.innerHTML = '<tr><td colspan="4" class="text-center py-4 text-muted">No hay conductores registrados</td></tr>';
            } else {
                drivers.forEach(driver => {
                    // Calculamos si el conductor está cargando actualmente
                    // Buscando si su ID está en algún CP con estado SUMINISTRANDO
                    const activeCp = cps.find(cp => cp.driver_id === driver.driver_id && cp.status === 'SUMINISTRANDO');
                    
                    let statusBadge = '<span class="badge bg-secondary">Inactivo</span>';
                    if (activeCp) {
                        statusBadge = `<span class="badge bg-primary"><i class="fa-solid fa-bolt me-1"></i>Cargando en CP-${activeCp.cp_id}</span>`;
                    }

                    // Formatear fecha
                    const regDate = new Date(driver.registration_date).toLocaleString();

                    const row = `
                        <tr>
                            <td class="ps-4 fw-bold text-dark">${driver.driver_id}</td>
                            <td>${statusBadge}</td>
                            <td class="text-muted small">${regDate}</td>
                            <td>
                                <button class="btn btn-sm btn-outline-secondary" disabled title="Gestión no implementada">
                                    <i class="fa-solid fa-gear"></i>
                                </button>
                            </td>
                        </tr>
                    `;
                    driversBody.innerHTML += row;
                });
            }

            // Actualizar Tarjetas
            document.getElementById('total-cps').innerText = cps.length;
            document.getElementById('active-cps').innerText = activeCount;
            document.getElementById('total-energy').innerText = totalEnergy.toFixed(1) + ' kWh';
            document.getElementById('total-revenue').innerText = totalRevenue.toFixed(2) + ' €';
        }

        function stopCP(cpId) {
            if(!confirm(`¿Seguro que quieres DETENER el CP-${cpId}? En caso de estar suministrando, se generará el ticket y finalizará la sesión.`)) return;

            fetch('/api/control/stop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cp_id: cpId })
            })
            .then(res => res.json())
            .then(data => {
                if(data.error) alert('Error: ' + data.error);
                else console.log('STOP enviado', data);
            })
            .catch(err => alert('Error de conexión'));
        }

        function resumeCP(cpId) {
            // No pedimos confirmación o una muy simple, ya que reactivar es seguro
            fetch('/api/control/resume', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ cp_id: cpId })
            })
            .then(res => res.json())
            .then(data => {
                if(data.error) alert('Error: ' + data.error);
                else console.log('RESUME enviado', data);
            })
            .catch(err => alert('Error de conexión'));
        }

        function showToast(notif) {
            const container = document.getElementById('toastContainer');

            // Icono según tipo
            const icon = notif.type === 'danger' ? '<i class="fa-solid fa-snowflake me-2"></i>' : '<i class="fa-solid fa-sun me-2"></i>';

            const html = `
                <div class="toast align-items-center text-white bg-${notif.type} border-0 show" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">
                            <strong class="me-auto">${icon} ${notif.title}</strong><br>
                            <small>${notif.time}</small>
                            <div class="mt-1">${notif.message}</div>
                        </div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close" onclick="this.parentElement.parentElement.remove()"></button>
                    </div>
                </div>
            `;

            // Insertar y auto-eliminar a los 6 segundos
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = html;
            const toastEl = tempDiv.firstElementChild;
            container.appendChild(toastEl);

            setTimeout(() => {
                if(toastEl) toastEl.remove();
            }, 8000);
        }

        setupEventSource();
    </script>
    <div class="toast-container position-fixed bottom-0 end-0 p-3" id="toastContainer" style="z-index: 1100;">
    </div>
</body>
</html>
